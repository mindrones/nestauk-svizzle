import {getAtlasId} from '@svizzle/atlas/src/utils';
import {
	applyFnMap,
	getValue,
	keyValueArrayAverage,
	keyValueArrayToObject,
} from '@svizzle/utils';
import * as _ from 'lamb';
import {derived} from 'svelte/store';

import {_lookup} from 'stores/dataset';
import {
	_colorScale,
	_getIndicatorValue,
	_indicator,
	_regionsYearSpec,
	_yearSelectionData,
} from 'stores/indicator';
import {_regionSettings} from 'stores/regionSettings';
import {getRegionAtlasId} from 'utils/domain';
import {makeGetRefFormatOf} from 'utils/format';

/* TODO not barchart specific, move to `stores/year.js` */

// generic

export const _regionIdValuePairs = derived(
	[_getIndicatorValue, _yearSelectionData],
	([getIndicatorValue, yearSelectionData]) => {
		let items = [];

		if (yearSelectionData) {
			const makeItems = _.pipe([
				_.mapWith(applyFnMap({
					key: getRegionAtlasId,
					value: getIndicatorValue
				})),
				_.sortWith([_.sorterDesc(getValue)])
			]);

			items = makeItems(yearSelectionData);
		}

		return items;
	}
);

export const _regionIdToValue =
	derived(_regionIdValuePairs, keyValueArrayToObject);

export const _regionIdToColor = derived(
	[_colorScale, _regionIdToValue],
	([colorScale, regionIdToValue]) => _.mapValues(regionIdToValue, colorScale)
);

// FIXME this could be removed once we have `atlasId` in the topojson
// https://github.com/nestauk/svizzle/issues/394
export const _regionIdToColorFn = derived(
	[_regionIdToColor, _regionSettings, _regionsYearSpec],
	([regionIdToColor, regionSettings, specYear]) =>
		regionId => {
			const atlasId = getAtlasId({
				regionId,
				specYear,
				type: regionSettings.type
			});
			const color = regionIdToColor[atlasId];

			return color;
		}
);

// barchart

export const _barchartRefs = derived(
	[_indicator, _lookup, _regionIdValuePairs],
	([indicator, lookup, regionIdValuePairs]) => {
		const getRefFormatFn = makeGetRefFormatOf(indicator.id);
		const formatFn = getRefFormatFn(lookup);

		return [{
			key: 'Average',
			keyAbbr: 'Avg.',
			value: keyValueArrayAverage(regionIdValuePairs),
			formatFn
		}];
	}
);
