<script>
	import {onMount} from 'svelte';
	import {makeStyleVars} from '@svizzle/dom';

	import {setGroupsStore} from 'stores/data';

	export let currentId = null;
	export let groupsStore;
	export let hrefBase = '';
	export let theme;

	let currentNode;
	let scrollable;
	let scrollableHeight;

	onMount(() => {
		currentNode && currentNode.scrollIntoView({
			block: 'nearest',
			behavior: 'smooth'
		});
	});

	$: groupsStore && setGroupsStore($groupsStore);
	$: style = makeStyleVars(theme);

	// eslint-disable-next-line no-shadow,no-unused-vars
	function keepOnScreen(node, {id, currentId, scrollableHeight}) {
		if (id === currentId) {
			currentNode = node;
		}

		return {
			// eslint-disable-next-line no-shadow,no-unused-vars
			update({id, currentId, scrollableHeight}) {
				if (id === currentId) {
					const {y: Y} = scrollable.getBoundingClientRect();
					const {y} = node.getBoundingClientRect();
					const yRel = y - Y;

					if (yRel < 0 || yRel > scrollableHeight) {
						scrollable.scrollTo({
							top: yRel,
							behavior: 'smooth'
						});
					}
				}
			}
		};
	}
</script>

<nav
	{style}
	bind:clientHeight={scrollableHeight}
	bind:this={scrollable}
>
	{#each $groupsStore as {label, indicators}}
		<div class='group'>
			<h2>{label}</h2>
			{#each indicators as {title, schema}}
				<a
					rel='prefetch'
					href='{hrefBase}/{schema.value.id}'
				>
					<p
						class:selected='{schema.value.id === currentId}'
						use:keepOnScreen={{
							id: schema.value.id,
							currentId,
							scrollableHeight
						}}
					>
					{title}
					</p>
				</a>
			{/each}
		</div>
	{/each}
</nav>

<style>
	nav {
		height: 100%;
		width: 100%;
		padding: var(--dimPadding);
		overflow-y: auto;

		background-color: var(--colorMain);
		border-right: 1px solid var(--colorMainLighter);
		color: var(--colorWhite);
		font-weight: var(--dimFontWeight);
	}

	nav .group:not(:last-child) {
		margin-bottom: 1rem;
	}
	nav .group:not(:first-child) {
		margin-top: 1rem;
	}

	nav h2 {
		font-family: var(--fontFamilySemibold), sans-serif;
		margin-bottom: 1rem;
	}
	nav a {
		text-decoration: none;
	}
	nav p {
		line-height: 1.5rem;
		display: flex;
		align-items: center;
		padding: 0.4rem;
		margin-bottom: 0.5rem;
	}
	nav p.selected {
		background-color: var(--colorMainDesat) !important;
		font-family: var(--fontFamilyRegular), sans-serif;
	}
	nav p:hover {
		cursor: pointer;
		background-color: var(--colorSelectedDesat);
	}
</style>
