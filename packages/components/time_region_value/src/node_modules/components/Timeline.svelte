<script>
	import * as _ from 'lamb';
	import {isNotNil} from '@svizzle/utils';

	import {shortenYear} from 'utils/format';
	import {yearRangeStore} from 'stores/data';
	import {timelineLayoutStore} from 'stores/layout';

	// sapper
	export let goTo = null; // pass `@sapper/app`'s `goto`

	// rest
	export let availableYears;
	export let height;
	export let hrefBase = '';
	export let indicatorId;
	export let selectedYear;
	export let width;

	$: layout = $timelineLayoutStore;
	$: yearsY = availableYears.length > 0 ? layout.y2 : layout.ym;

	/* buttons */

	$: buttonY = layout.height / 4;
	$: buttonSize = layout.height / 2;
	$: min = buttonSize / 3;
	$: max = 2 * min;
	$: med = buttonSize / 2;
	$: chevronLeftPath = `${max} ${min} ${min} ${med} ${max} ${max}`;
	$: chevronRightPath = `${min} ${min} ${max} ${med} ${min} ${max}`;
	$: selectedYearIndex = _.findIndex(availableYears, _.is(selectedYear));
	$: prevYear = availableYears[selectedYearIndex - 1];
	$: isPrevYearActive = isNotNil(prevYear);
	$: nextYear = availableYears[selectedYearIndex + 1];
	$: isNextYearActive = isNotNil(nextYear);
	$: clickedPrev =
		() => isPrevYearActive && goTo(`indicators/${indicatorId}/${prevYear}`);
	$: clickedNext =
		() => isNextYearActive && goTo(`indicators/${indicatorId}/${nextYear}`);
</script>

<div class="Timeline">
	{#if width && layout}
	<svg
		{width}
		{height}
	>
		<!-- buttons -->
		{#if selectedYear}

			<!-- prev -->
			<g
				transform='translate({buttonY},{buttonY})'
				class:active={isPrevYearActive}
			>
				<rect
					height={buttonSize}
					width={buttonSize}
					on:click={clickedPrev}
				/>
				<polyline points={chevronLeftPath} />
			</g>

			<!-- next -->
			<g
				transform='translate({1.25 * buttonY + buttonSize},{buttonY})'
				class:active={isNextYearActive}
			>
				<rect
					height={buttonSize}
					width={buttonSize}
					on:click={clickedNext}
				/>
				<polyline points={chevronRightPath} />
			</g>
		{/if}

		<!-- dots -->
		{#if availableYears}
		<g transform='translate(0,{layout.y1})'>
			<line
				x1='{layout.scaleX(availableYears[0]) + layout.radius}'
				x2='{layout.scaleX(_.last(availableYears)) - layout.radius}'
			/>
			{#each availableYears as year}
			<circle
				class:selected='{selectedYear && selectedYear === year}'
				cx='{layout.scaleX(year)}'
				r={layout.radius}
				on:click='{() => goTo(`${hrefBase}/${indicatorId}/${year}`)}'
			/>
			{/each}
		</g>
		{/if}

		<!-- labels -->
		{#if $yearRangeStore}
			{#each $yearRangeStore as year}
				<text
					font-size={layout.fontSize}
					x={layout.scaleX(year)}
					y={yearsY}
				>{layout.doShortenYears ? shortenYear(year): year}</text>
			{/each}
		{/if}
	</svg>
	{/if}
</div>

<style>
	.Timeline {
		height: 100%;
		width: 100%;
		user-select: none;
	}

	svg text {
		stroke: none;
		fill: var(--color-grey-70);
		dominant-baseline: middle;
		text-anchor: middle;
		pointer-events: none;
	}

	svg line {
		stroke: var(--color-grey-70);
		stroke-width: 0.75;
		pointer-events: none;
	}

	svg circle {
		fill-opacity: 1;
		fill: white;
		stroke: var(--color-grey-70);
		stroke-width: 1.5;
		cursor: pointer;
	}
	svg circle.selected {
		fill: var(--color-main-desat-50);
	}

	/* buttons */

	rect {
		fill: white;
	}
	polyline {
		fill: none;
		stroke-width: 2;
		pointer-events: none;
	}

	rect, polyline {
		stroke: var(--color-grey-180);
	}
	.active {
		cursor: pointer;
	}
	.active rect,
	.active polyline {
		stroke: var(--color-grey-70);
	}
</style>
