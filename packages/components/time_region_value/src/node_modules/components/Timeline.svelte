<script>
	import * as _ from 'lamb';
	import {isNotNil} from '@svizzle/utils';
	import {makeStyleVars} from '@svizzle/dom';

	import defaultTheme from 'theme';
	import {yearRangeStore} from 'stores/data';
	import {timelineLayoutStore} from 'stores/layout';
	import {shortenYear} from 'utils/format';

	// sapper
	export let goTo = null; // pass `@sapper/app`'s `goto`

	// rest
	export let availableYears;
	export let height;
	export let hrefBase = '';
	export let indicatorId = null;
	export let selectedYear = null;
	export let showLess = false;
	export let theme = defaultTheme;
	export let width;

	// FIXME https://github.com/sveltejs/svelte/issues/4442
	$: theme = theme ? {...defaultTheme, ...theme} : defaultTheme;

	$: style = makeStyleVars(theme);
	$: layout = $timelineLayoutStore;
	$: yearsY = availableYears.length > 0 ? layout.y2 : layout.ym;

	/* buttons */

	$: halfHeight = layout.height / 2;
	$: buttonY = halfHeight / 2;
	$: prevX = buttonY;
	$: nextX = buttonY + halfHeight + 0.25 * buttonY;
	$: yearsCenterX = (nextX + halfHeight + width) / 2;
	$: min = halfHeight / 3;
	$: max = 2 * min;
	$: med = halfHeight / 2;
	$: chevronLeftPath = `${max} ${min} ${min} ${med} ${max} ${max}`;
	$: chevronRightPath = `${min} ${min} ${max} ${med} ${min} ${max}`;
	$: selectedYearIndex = _.findIndex(availableYears, _.is(selectedYear));
	$: prevYear = availableYears[selectedYearIndex - 1];
	$: isPrevYearActive = isNotNil(prevYear);
	$: nextYear = availableYears[selectedYearIndex + 1];
	$: isNextYearActive = isNotNil(nextYear);
	$: clickedPrev =
		() => isPrevYearActive && goTo(`${hrefBase}/${indicatorId}/${prevYear}`);
	$: clickedNext =
		() => isNextYearActive && goTo(`${hrefBase}/${indicatorId}/${nextYear}`);
</script>

<div
	{style}
	class='Timeline'
>
	{#if width && layout}
	<svg
		{width}
		{height}
	>
		<!-- buttons -->
		{#if selectedYear}

			<!-- prev -->
			<g
				transform='translate({prevX},{buttonY})'
				class:active={isPrevYearActive}
			>
				<rect
					height={halfHeight}
					width={halfHeight}
					on:click={clickedPrev}
				/>
				<polyline points={chevronLeftPath} />
			</g>

			<!-- next -->
			<g
				transform='translate({nextX},{buttonY})'
				class:active={isNextYearActive}
			>
				<rect
					height={halfHeight}
					width={halfHeight}
					on:click={clickedNext}
				/>
				<polyline points={chevronRightPath} />
			</g>
		{/if}

		{#if showLess && selectedYear}

			<text
				x={yearsCenterX}
				y={halfHeight}
			>{selectedYear}</text>

		{:else}

			<!-- dots -->

			{#if availableYears}
				<g transform='translate(0,{layout.y1})'>
					<line
						x1='{layout.scaleX(availableYears[0]) + layout.radius}'
						x2='{layout.scaleX(_.last(availableYears)) - layout.radius}'
					/>
					{#each availableYears as year}
						<circle
							class:selected='{selectedYear && selectedYear === year}'
							cx='{layout.scaleX(year)}'
							r={layout.radius}
							on:click='{() => goTo(`${hrefBase}/${indicatorId}/${year}`)}'
						/>
					{/each}
				</g>
			{/if}

			<!-- labels -->

			{#if $yearRangeStore}
				{#each $yearRangeStore as year}
					<text
						font-size={layout.fontSize}
						x={layout.scaleX(year)}
						y={yearsY}
					>{layout.doShortenYears ? shortenYear(year): year}</text>
				{/each}
			{/if}

		{/if}
	</svg>
	{/if}
</div>

<style>
	.Timeline {
		height: 100%;
		user-select: none;
		width: 100%;
	}

	svg text {
		dominant-baseline: middle;
		fill: var(--colorRef);
		pointer-events: none;
		stroke: none;
		text-anchor: middle;
	}

	svg line {
		pointer-events: none;
		stroke-width: 0.75;
		stroke: var(--colorRef);
	}

	svg circle {
		cursor: pointer;
		fill-opacity: 1;
		fill: var(--colorWhite);
		stroke-width: 1.5;
		stroke: var(--colorRef);
	}
	svg circle.selected {
		fill: var(--colorSelected);
	}

	/* buttons */

	rect {
		fill: var(--colorWhite);
	}
	polyline {
		fill: none;
		pointer-events: none;
		stroke-width: 2;
	}

	rect, polyline {
		stroke: var(--colorRefLight);
	}
	.active {
		cursor: pointer;
	}
	.active rect,
	.active polyline {
		stroke: var(--colorRef);
	}
</style>
